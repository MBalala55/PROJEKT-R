# Offline-First Implementation Notes

This document describes the offline-first implementation of the Elektropregled Android app.

## Overview

The app has been refactored to work **fully offline** for all features except **LOGIN**, which remains **online-only**. All data is stored locally in a SQLite database (via Room), and the app reads from the local database first. Network synchronization happens in the background when online.

## Architecture

### Offline-First Pattern

1. **UI reads from local DB** (via Flow/StateFlow for reactive updates)
2. **Repositories coordinate**:
   - Read from local DB for immediate display
   - Sync with server in background when online
   - Write to local DB after network fetch
3. **Single Source of Truth**: Local database is the authoritative source for UI

### Seed Database

A prebuilt SQLite database (`seed.db`) is generated from source data and bundled with the app:

- **Location**: `android-app/app/src/main/assets/database/seed.db`
- **Generated by**: `tools/generate_seed_db.py`
- **Source data**:
  - Excel file: `tools/input/testniPodaci.xlsx` (test data)
  - JSON mapping: `tools/input/checklist_mapping.json` (checklist items per device type)

## Seed Database Generation

### Prerequisites

```bash
pip install -r tools/requirements.txt
```

### Running the Generator

```bash
python tools/generate_seed_db.py
```

This script:
1. Reads Excel data from `tools/input/testniPodaci.xlsx`
2. Loads checklist mapping from `tools/input/checklist_mapping.json`
3. Creates SQLite database with schema from `baza/scripts/mobilna_sqlite.sql`
4. Inserts all data (postrojenja, polja, vrste uredaja, uredaji, parametri)
5. Validates data integrity
6. Outputs `seed.db` to `android-app/app/src/main/assets/database/`

### Input Files

- **Excel file** (`testniPodaci.xlsx`): Contains sheets:
  - `postrojenje`: Facilities (id_postr, ozn_vr_postr, naz_postr)
  - `polje`: Fields (id_polje, nap_razina, ozn_vr_polje, naz_polje, id_postr)
  - `vrstaUredjaja`: Device types (ozn_vr_ured, naz_vr_ured)
  - `uredjaj`: Devices (id_ured, ozn_vr_ured, natp_plocica, tv_broj, id_postr, id_polje)

- **Checklist mapping** (`checklist_mapping.json`): Maps device type codes (e.g., "TR", "IS") to checklist parameters:
  ```json
  {
    "TR": [
      {
        "naz_parametra": "Vizualna provjera općeg stanja",
        "tip_podataka": "BOOLEAN",
        "obavezan": true,
        "redoslijed": 1,
        "opis": "..."
      }
    ]
  }
  ```

### Output

- **Seed DB**: `android-app/app/src/main/assets/database/seed.db`
- **Size**: ~1.2 MB (contains all test data)
- **Schema**: Matches `mobilna_sqlite.sql`

## Runtime Database Initialization

### First Run

On first app launch:

1. `AppDatabase.getDatabase()` is called
2. `copySeedDatabaseIfNeeded()` checks if database exists
3. If not, copies `seed.db` from assets to app's database directory
4. Room opens the copied database
5. Foreign keys are enabled

### Subsequent Runs

- Database already exists, Room opens it directly
- Migrations are handled by Room (if schema version changes)

### Database Reset (Debug)

For testing, you can reset the database:

```kotlin
AppDatabase.resetDatabase(context)
```

This deletes the existing database and will copy the seed DB on next access.

## Repository Pattern (Offline-First)

### PostrojenjeRepository

**Offline-First Methods:**
- `getPostrojenjaFlow()`: Returns `Flow<List<PostrojenjeSummary>>` from local DB
- `getPoljaFlow(postrojenjeId)`: Returns `Flow<List<PoljeDto>>` from local DB

**Sync Methods:**
- `syncPostrojenja()`: Fetches from server and updates local DB
- `triggerSyncIfOnline()`: Automatically syncs in background if online

**Usage:**
```kotlin
// ViewModel observes Flow (offline-first)
repository.getPostrojenjaFlow()
    .collect { facilities ->
        // UI updates immediately with local data
    }

// Trigger background sync
repository.triggerSyncIfOnline(viewModelScope)
```

### ChecklistRepository

**Offline-First Methods:**
- `getChecklistFlow(postrojenjeId, poljeId)`: Returns `Flow<List<ChecklistUredaj>>` from local DB
- `getChecklist()`: Backward-compatible suspend function (reads from local DB, syncs if empty)

**Sync Methods:**
- `syncChecklist(postrojenjeId, poljeId)`: Fetches from server and updates local DB

**Usage:**
```kotlin
// ViewModel observes Flow
repository.getChecklistFlow(postrojenjeId, poljeId)
    .collect { checklist ->
        // UI updates with local data
    }
```

## Login (Online-Only)

Login **requires** network connectivity:

```kotlin
// LoginViewModel checks network before attempting login
if (!NetworkUtil.isNetworkAvailable(context)) {
    // Show error: "Prijava zahtijeva internetsku vezu"
    return
}

// Only then attempts API call
val response = apiService.login(LoginRequest(username, password))
```

**Behavior:**
- If offline: Shows clear error message, does not attempt login
- If online: Proceeds with login, stores JWT token securely
- Token validation: App checks token validity before allowing offline features

## Sync Strategy

### Pull Sync (Server → Local)

When online:
1. Repositories fetch data from server
2. Data is upserted into local DB (REPLACE strategy)
3. UI automatically updates via Flow (reactive)

### Push Sync (Local → Server)

For inspections (Pregled):
1. Inspections are created locally with `lokalni_id` (UUID)
2. Status: `PENDING` → `SYNCING` → `SYNCED` or `FAILED`
3. When online, `PregledRepository.syncPregledi()` sends pending inspections
4. Server returns server IDs, which are stored locally

### Conflict Handling

- **Last-write-wins**: Server data overwrites local data on pull sync
- **Optimistic updates**: Local changes are saved immediately, synced later
- **Error handling**: Failed syncs are marked `FAILED` with error message, can be retried

## Data Flow

### Reading Data

```
UI (Fragment/Activity)
  ↓ observes
ViewModel (StateFlow)
  ↓ collects
Repository.getXxxFlow()
  ↓ emits
DAO Flow (Room)
  ↓ queries
Local SQLite DB
```

### Writing Data

```
User Action
  ↓
ViewModel
  ↓
Repository.saveXxx() (writes to local DB)
  ↓
DAO.insert/update
  ↓
Local SQLite DB
  ↓ (if online)
Repository.syncXxx() (background)
  ↓
API Service
  ↓
Server
```

## Network Detection

`NetworkUtil` provides:
- `isNetworkAvailable(context)`: Checks if device has internet
- `isWifiConnected(context)`: Checks if connected via WiFi

Used by:
- Login (requires network)
- Sync operations (only when online)
- UI indicators (show offline status)

## Testing

### Offline Testing

1. Enable Airplane Mode
2. App should:
   - Show cached data immediately
   - Allow creating/editing inspections
   - Show "offline" indicators where appropriate
   - Block login with clear error message

### Online Testing

1. Ensure network connectivity
2. App should:
   - Sync data in background
   - Update UI reactively when DB changes
   - Allow login
   - Sync pending inspections

### Seed DB Testing

1. Reset database: `AppDatabase.resetDatabase(context)`
2. Restart app
3. Verify seed data is loaded (check Postrojenje count, etc.)

## File Locations

### Source Data (for maintainers)

- `tools/input/testniPodaci.xlsx` - Excel test data
- `tools/input/popisProvjeraPoVrstamaUredjaja.pdf` - PDF with checklist items (reference)
- `tools/input/checklist_mapping.json` - JSON mapping of checklist items per device type

### Generated Files

- `android-app/app/src/main/assets/database/seed.db` - Prebuilt SQLite database (bundled with app)
- `tools/generate_seed_db.py` - Seed DB generation script

### Database Files (Runtime)

- `{app_data_dir}/databases/elektropregled_database` - Runtime database (writable)

## Migration Strategy

When schema changes:

1. Update `mobilna_sqlite.sql` with new schema
2. Increment database version in `AppDatabase`:
   ```kotlin
   @Database(..., version = 2)  // was 1
   ```
3. Add migration:
   ```kotlin
   val MIGRATION_1_2 = object : Migration(1, 2) {
       override fun migrate(database: SupportSQLiteDatabase) {
           // Migration SQL
       }
   }
   ```
4. Regenerate seed DB: `python tools/generate_seed_db.py`
5. Update seed version in `AppDatabase.copySeedDatabaseIfNeeded()` if needed

## Troubleshooting

### Database not initializing

- Check `seed.db` exists in `assets/database/`
- Check logs for copy errors
- Verify database directory permissions

### Data not syncing

- Check network connectivity
- Check JWT token validity
- Check logs for API errors
- Verify sync methods are being called

### Checklist items missing

- Verify `checklist_mapping.json` has entries for all device types
- Check seed DB generation logs
- Verify `ParametarProvjere` table has data

## Summary

The app now works **fully offline** except for login:

✅ **Offline**: View facilities, fields, devices, checklist items, create/edit inspections
❌ **Online Required**: Login only

All data is stored locally and synced when online. The seed database ensures the app has initial data even on first launch without network.
